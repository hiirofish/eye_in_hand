# Dobot Eye-in-Hand 把持システム

Dobot Magician + Eye-in-Hand カメラ構成による自動物体探索・把持システム。

## 概要

カメラをアーム先端（グリッパー横）に取り付けた Eye-in-Hand 構成で、
作業面上のブロック状物体を自動探索し、角度を合わせて把持する。

主な特徴:
- JOG コマンドベースのビジュアルサーボ（J1回転 + Reach伸縮）
- TGT（ターゲット座標）の 2 点線形補間による Z 高さ補正
- 全 Z 値を「床からの相対値」で管理 → 電源再投入時のZ原点ズレに対応
- R 軸角度合わせによる物体長辺方向への把持

## バージョン履歴

| Ver | 内容 |
|-----|------|
| v7.2 | グリッパー制御完動版 |
| v8.x | 差分法・数式法を試行 → 不安定で断念 |
| v9.0 | カメラ垂直前提・obj 角度合わせ |
| v10.0 | キャリブレーション統合・サーボ降下 3 段階化 |
| v10.1 | TGT キャリブ値を tgt_calibration.json から読み込み |
| v10.2 | **全 Z 値を床基準の相対値に変換** / TGT オフセット自動補正 / ステップ式キャリブツール |

---

## ファイル構成

```
dobot_test/
├── DobotDll.dll              ← Dobot SDK (DLL)
├── DobotDllType.py           ← Dobot SDK (Python バインディング)
├── msvcp120.dll, msvcr120.dll, Qt5*.dll 等  ← SDK 依存ライブラリ
├── sample_*.py               ← Dobot 公式サンプル
│
└── eye_in_hand/              ← ★ 自作プログラム (このフォルダ)
    ├── final_approach.py         メインプログラム (v10.2)
    ├── tgt_calibration_tool.py   TGT キャリブツール (v2)
    ├── search_ajuster.py         スキャン範囲調整ツール
    ├── search_ajuster_speed.py   スキャン速度調整版
    ├── reset.py                  アラームリセット等
    │
    ├── hand_calibration.json     ハンド基準 (R-J1) + 床Z
    ├── tgt_calibration.json      TGT 2 点キャリブ値
    ├── gripper_calibration.json  グリッパー R オフセット
    └── scan_area.json            J1 スキャン範囲
```

`eye_in_hand/` 内の Python ファイルは起動時に `sys.path` と `os.chdir` で
親ディレクトリ（`dobot_test/`）を参照するため、DLL・SDK の配置を変更する必要はない。

---

## 動作フロー

### 全体の流れ

```
Step 0: キャリブレーション（初回・電源再投入後）
  └→ ハンドを開き、水平にし、床につけて保存
      → R-J1 基準値 + floor_z を hand_calibration.json に記録

Step 1: 探索
  ├→ JOG スキャン（J1 回転で物体を探す）
  ├→ キャリブ計測（J1/Reach の px/sec を実測）
  ├→ 粗動サーボ（比例制御で TGT に近づける）
  ├→ 微調整サーボ（低速 JOG で収束）
  └→ サーボ付き Z 降下（3 段階で降りながら位置補正）

Step 2: R 軸角度合わせ
  └→ 物体の長辺方向にハンドの爪を合わせる

Step 3: 把持
  ├→ ブラインド降下（床+2mm まで一気に降りる）
  ├→ グリッパー閉じ
  └→ 持ち上げ（床+52mm）
```

### 自動探索

「▶ 自動探索」ボタンで Step 1 → 2 → 3 を連続実行する。

---

## Z 座標設計 (v10.2)

### 背景

Dobot Magician は電源投入時にステッピングモーターの位置を初期化するため、
起動時のアーム姿勢によって Z 軸の原点が数 mm ずれることがある。
（例: 前回 Z=-32 が床だったのに、今回は Z=-23 が床になる）

### 解決策: 床基準の相対 Z 値

すべての Z 値を「床からの高さ（相対値）」で定義し、
Step 0 で記録した `floor_z` を基準に絶対値へ変換する。

```
絶対Z = floor_z + 相対Z
例: floor_z = -23, Z_GRASP_REL = +2 → 実際の Z = -21
```

### Z 定数一覧

| 定数 | 値 | 意味 |
|------|-----|------|
| `Z_GRASP_REL` | +2mm | 把持高さ（ブロックの厚み分） |
| `Z_APPROACH_REL` | +32mm | R 軸合わせ時の高さ |
| `Z_DESCENT_REL` | [+62, +42, +32] | サーボ降下ステップ |
| `Z_LIFT_REL` | +52mm | 持ち上げ後の高さ |

### TGT オフセット補正

TGT キャリブは特定の `floor_z` 時に取得されるが、
電源再投入で `floor_z` が変わっても、物理的なカメラ-床間距離は同じなので
Z 値の差分だけオフセット補正すれば TGT キャリブのやり直しは不要。

```python
# TGTキャリブ時: floor_z=-32 で Z1=-32, Z2=88 を記録
# 今回起動時:    floor_z=-23 (9mmズレ)
# → Z1=-32+9=-23, Z2=88+9=97 と読み替える
```

---

## キャリブレーション手順

### Step 0: ロボットアームキャリブ（毎回の起動時）

**手順:**
1. Dobot に接続
2. グリッパーを **開く**
3. 手動 JOG でハンドの爪を **カメラに対して水平** にする
4. アームを **床まで降ろす**（爪が床に触れる状態）
5. 「★ キャリブ保存」ボタンを押す

**記録される値:**
- `hand_base_diff` = R - J1（ハンド角度の基準）
- `floor_z` = その時の Z 座標（床の絶対位置）

**保存先:** `hand_calibration.json`

### TGT キャリブレーション（カメラ位置変更時のみ）

`tgt_calibration_tool.py` を使用する。

**手順:**
1. 作業面に目印（×印）を付ける
2. Dobot 接続 → カメラ開始

3. **Step 1: 床の位置を記録**
   - 手動 JOG でグリッパー先端を目印の真上に移動
   - アームを床まで降ろし、先端を目印にぴったり合わせる
   - 「★ 床の位置を記録」ボタンを押す

4. **Step 2: 床位置の目印をクリック**
   - カメラ画面上の目印（×印）をクリック → 点 1 を記録

5. **Step 3: 床+110mm で目印をクリック**
   - 「▲ 床+110mm へ移動」ボタンでアームを上げる（**XY はそのまま**）
   - カメラ画面上の **同じ目印** をクリック → 点 2 を記録

6. **Step 4: JSON に保存**

**★ 重要:** Step 2 → 3 で **XY 位置は絶対に動かさない**。Z だけ変える。
これにより、同一地点のパースペクティブ変化（高さによる見え方の違い）を正しく記録できる。

**保存先:** `tgt_calibration.json`

---

## TGT 線形補間の仕組み

Eye-in-Hand 構成ではカメラがアームと一緒に上下するため、
同じ地点でも Z 高さによって画面上の見え方が変わる。

```
Z 高い (88mm)  → 物体が画面下方 (Y 大) に見える
Z 低い (-32mm) → 物体が画面上方 (Y 小) に見える
```

2 点のキャリブデータから線形補間で、任意の Z 高さでの TGT 座標を計算する：

```python
ratio = (Z - Z1) / (Z2 - Z1)
tgt_x = X1 + (X2 - X1) * ratio
tgt_y = Y1 + (Y2 - Y1) * ratio
```

---

## 依存関係

- Python 3.x
- OpenCV (`cv2`)
- NumPy
- Pillow (`PIL`)
- tkinter（標準ライブラリ）
- Dobot SDK（`DobotDllType.py` + `DobotDll.dll`）

## 起動方法

```bash
cd dobot_test/eye_in_hand
python final_approach.py
```

起動時のログで以下を確認：
- `床Z: ○○mm` → Step 0 キャリブ済み
- `床Z: 未設定 ⚠` → Step 0 が必要
- `TGTキャリブ読み込み` → tgt_calibration.json 読み込み済み